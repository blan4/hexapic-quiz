<!doctype html>
<html>
    <head>
        <meta name="viewport" content="width=device-width, minimum-scale=1.0, initial-scale=1.0, user-scalable=yes">
        <script src="bower_components/webcomponentsjs/webcomponents.min.js"></script>
        <link rel="import" href="bower_components/polymer/polymer.html">
        <link rel="import" href="bower_components/core-scaffold/core-scaffold.html">
        <link rel="import" href="bower_components/core-image/core-image.html">
        <link rel="import" href="bower_components/paper-ripple/paper-ripple.html">
        <link rel="import" href="bower_components/paper-radio-button/paper-radio-button.html">
        <link rel="import" href="bower_components/paper-radio-group/paper-radio-group.html">
        <link rel="import" href="bower_components/core-ajax/core-ajax.html">
        <link rel="import" href="bower_components/paper-toast/paper-toast.html">
        <link rel="import" href="bower_components/paper-progress/paper-progress.html">
        <link rel="stylesheet" shim-shadowdom href="app.css">
    </head>

    <body unresolved>
    <paper-toast text="Answer is wrong. Try again!"></paper-toast>
    <core-header-panel navigation flex>
        <core-toolbar style="height: 250px">
            <h1>Hexapic Quest</h1>
        </core-toolbar>
        <section vertical layout>
            <p id="score">Score: </p>
            <paper-progress value="0"></paper-progress>
            <paper-radio-group role="radiogroup">
                <template id="answers" repeat="{{ variants }}">
                    <paper-radio-button name="{{}}" label="{{}}" role="radio"></paper-radio-button>
                </template>
            </paper-radio-group>
            <div class="button raised green" id="submit">
                <div class="center">Ok</div>
                <paper-ripple fit></paper-ripple>
            </div>
            <core-ajax
                    auto
                    url="//hexapicserv.appspot.com/random"
                    handleAs="json"></core-ajax>
        </section>
    </core-header-panel>
    <div class="image_container">
        <core-image id="question" class="quiz_image" sizing="cover"></core-image>
    </div>
    <script>
        document.addEventListener('polymer-ready', function(){
            var ajax = document.querySelector('core-ajax');
            var button = document.querySelector('#submit');
            var toast = document.querySelector('paper-toast');
            var answer = document.querySelector('paper-radio-group');
            var img = document.querySelector('#question');
            var totalScore = 0;
            var passedQuestions = 10;
            var score = document.querySelector('#score');
            var progress = document.querySelector('paper-progress');
            button.addEventListener('click', function(e){
                if (answer.selected != null) {
                    ajax.params = {uid: button.model['uid'], answer: answer.selected};
                }
            });
            ajax.addEventListener('core-response', function(e){
                console.log(e.detail.response);
                data = e.detail.response;

                if (data['uid'] !== undefined) {
                    img.src = "http://hexapicserv.appspot.com/random?uid=" + data['uid'];

                    button.model = {
                        uid: data['uid']
                    };

                    document.querySelector('#answers').model = {
                        variants: e.detail.response.variants
                    };
                } else {
                    if (data['isRight'] !== undefined) {
                        if (data['isRight'] == "true") {
                            toast.text = "Good job. Next picture!";
                            totalScore += 10;
                            toast.show();
                            if (passedQuestions <= 0) {
                                console.log('WellDone');
                            } else {
                                passedQuestions -= 1;
                            }
                            progress.value = (10 - passedQuestions)*10;
                            ajax.params = '';
                        } else {
                            toast.text = "Answer "+data['answer']+" is wrong. Try again!.";
                            toast.show();
                            if (totalScore != 0) {
                                totalScore -= 5;
                            }
                        }
                    }
                }
                score.innerHTML = "Score: "+totalScore;
            });
        });
    </script>
    </body>
</html>